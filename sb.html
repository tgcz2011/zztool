<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>豆语</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=EB+Garamond:wght@500&family=Ma+Shan+Zheng&display=swap');

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: url('/image/background.png') center/cover no-repeat;
            perspective: 1000px;
            overflow: hidden;
            font-family:
                'EB Garamond',
                'Ma Shan Zheng',
                cursive;
        }

        :lang(zh) {
            font-family: 'Ma Shan Zheng', 'EB Garamond', cursive;
        }

        .quote-container {
            position: relative;
            width: 80%;
            max-width: 800px;
            min-height: 300px;
            color: #fff;
            text-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .quote-box {
            position: absolute;
            width: 100%;
            opacity: 0;
            transform: translateY(50px) rotateX(45deg);
            transition: all 1.2s cubic-bezier(0.19, 1, 0.22, 1);
            text-align: center;
        }

        .quote-box.active {
            opacity: 1;
            transform: translateY(0) rotateX(0);
        }

        .content {
            font-size: 2.2em;
            line-height: 1.6;
            white-space: pre-line;
            margin-bottom: 15px;
            letter-spacing: 0.03em;
        }

        .author {
            font-size: 1.6em;
            color: #FFE082;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            font-style: italic;
        }

        .nav-arrow {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3em;
            color: #FFE082;
            cursor: pointer;
            text-shadow: 0 0 15px rgba(0,0,0,0.5);
            user-select: none;
        }

        .prev { left: 30px; }
        .next { right: 30px; }
    </style>
</head>
<body>
    <div class="nav-arrow prev">‹</div>
    <div class="nav-arrow next">›</div>

    <div class="quote-container">
        <div class="quote-box active">
            <div class="content"></div>
            <div class="author"></div>
        </div>
        <div class="quote-box">
            <div class="content"></div>
            <div class="author"></div>
        </div>
    </div>

    <script>
        let quotes = [];
        let currentIndex = 0;
        let autoChange = true;
        let boxes = document.querySelectorAll('.quote-box');
        let history = [];

        function parseQuotes(text) {
            return text.split('##').filter(q => q.trim()).map(quote => {
                const lines = quote.trim().split('\n').filter(l => l.trim());
                return {
                    content: lines.slice(0, -1).join('\n'),
                    author: lines[lines.length-1].replace(/^[——]+/, '').trim()
                };
            });
        }

        function getRandomIndex() {
            if (quotes.length <= 1) return 0;

            // 历史记录保留最近3次
            if(history.length > 3) history.shift();

            let candidates = quotes
                .map((_, i) => i)
                .filter(i => i !== currentIndex && !history.includes(i));

            // 如果没有候选则重置历史
            if(candidates.length === 0) {
                history = [];
                candidates = quotes.map((_, i) => i).filter(i => i !== currentIndex);
            }

            const newIndex = candidates[Math.floor(Math.random() * candidates.length)];
            history.push(newIndex);
            return newIndex;
        }

        function switchToIndex(newIndex) {
            autoChange = false;
            currentIndex = newIndex;

            const activeBox = document.querySelector('.quote-box.active');
            const nextBox = activeBox === boxes[0] ? boxes[1] : boxes[0];

            nextBox.querySelector('.content').textContent = quotes[currentIndex].content;
            nextBox.querySelector('.author').textContent = quotes[currentIndex].author;

            activeBox.classList.remove('active');
            nextBox.classList.add('active');

            setTimeout(() => autoChange = true, 2500);
        }

        function changeQuote(direction) {
            const newIndex = (currentIndex + direction + quotes.length) % quotes.length;
            switchToIndex(newIndex);
        }

        function randomChange() {
            if (!autoChange) return;
            switchToIndex(getRandomIndex());
        }

        async function init() {
            const response = await fetch('/text/sb.txt');
            const text = await response.text();
            quotes = parseQuotes(text);

            // 立即显示第一条
            boxes[0].querySelector('.content').textContent = quotes[0].content;
            boxes[0].querySelector('.author').textContent = quotes[0].author;
            boxes[0].classList.add('active');

            // 启动智能随机轮播
            setInterval(randomChange, 5000);
        }

        // 事件绑定
        document.querySelector('.prev').addEventListener('click', () => changeQuote(-1));
        document.querySelector('.next').addEventListener('click', () => changeQuote(1));
        document.addEventListener('keydown', (e) => {
            if(e.key === 'ArrowLeft') changeQuote(-1);
            if(e.key === 'ArrowRight') changeQuote(1);
        });

        init().catch(console.error);
    </script>
</body>
</html>